name: Run Kotlin solvers

on:
  workflow_dispatch: {}
  push:
    paths:
      - '**.kt'
      - 'resources/**'
      - '.github/workflows/**'
  pull_request:
    paths:
      - '**.kt'
      - 'resources/**'

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Download Kotlin compiler
        run: |
          KOTLIN_VERSION=1.9.10
          curl -sSL "https://github.com/JetBrains/kotlin/releases/download/v${KOTLIN_VERSION}/kotlin-compiler-${KOTLIN_VERSION}.zip" -o kotlin.zip
          unzip kotlin.zip -d $HOME
          # rename to include version (idempotent)
          if [ -d "$HOME/kotlinc" ]; then
            mv -f $HOME/kotlinc $HOME/kotlinc_${KOTLIN_VERSION} || true
          fi
          echo "$HOME/kotlinc_${KOTLIN_VERSION}/bin" >> $GITHUB_PATH

      - name: Compile Kotlin sources
        run: |
          mkdir -p build/classes
          # find and compile all Kotlin source files
          SRC_FILES=$(find src -name "*.kt" -print | tr '\n' ' ')
          if [ -z "$SRC_FILES" ]; then
            echo "No Kotlin sources found in src/"
            exit 1
          fi
          kotlinc -d build/classes $SRC_FILES

      - name: Run solvers (Main)
        run: |
          # resources/ should be on the classpath root so getResourceAsStream("/day1.input") works
          # Fail the step if any command fails and make pipeline return failure if kotlin fails
          set -euo pipefail
          mkdir -p outputs
          # Capture BOTH stdout and stderr from the Kotlin program into the file and to the Actions log
          # - 2>&1 redirects stderr to stdout
          # - tee writes stdout to the file and also to the runner log
          kotlin -cp "build/classes:resources" MainKt 2>&1 | tee outputs/solvers_output.txt

      - name: Upload solvers output
        uses: actions/upload-artifact@v4
        with:
          name: solvers-output
          path: outputs/solvers_output.txt
